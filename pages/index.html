<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<meta name="author" content="Ítalo Santos">
	<title>Formatador de Resposta META PLATFORM, INC.</title>

	<link href="../node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

	<main>
		<h1 class="visually-hidden">Heroes examples</h1>

		<div class="px-4 py-5 my-5 text-center">
			<img class="d-block mx-auto mb-4" src="../resources/img/meta-logo.png" alt="" height="150">
			<h1 class="display-5 fw-bold">Formatador de Respostas</h1>
			<div class="col-lg-6 mx-auto">
				<p class="lead mb-5">Tem como objetivo ler e tratar as respostas de <strong>ofícios</strong> e <strong>representações</strong> encaminhadas à empresa <strong>META PLATFORM, INC</strong>, referente a informações do <strong>Facebook, Instagram e WhatsApp.</strong> Ao final do processo, é gerado um arquivo <strong>Excel</strong>, contendo data e hora convertidos para o <strong>fuso horário GMT-3</strong>, além dos <strong>IP's e provedores de internet</strong> identificadas na resposta.</p>
				
				<form id="formFile" action="/file" method="post" enctype="multipart/form-data"> 
					<div class="input-group mb-2">
						<input id="inputFile" name="file" type="file" class="form-control form-control-lg" aria-label="Upload" accept=".html" required="required">
						<button id="btnSend" class="btn btn-primary btn-lg" type="submit">Enviar!</button>
					</div>
				</form>
				
				<p class="text-muted"><small><strong>Atenção!</strong> O arquivo a ser processado deve estar no formato <strong>HTML</strong>.</small></p>
			</div>
		</div>
	</main>

	<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-body text-center">
					<div class="spinner-border text-primary mb-3 m-3" role="status">
						<span class="visually-hidden">Loading...</span>
					</div>
					<h2 class="text-primary m-3">Processando Arquivo!</h2>
					<p class="text-muted">Essa ação pode demorar levar alguns minutos, dependendo da quantidade de IP's identificados.</p>
				</div>
			</div>
		</div>
	</div>

	<script src="../node_modules/jquery/dist/jquery.min.js"></script>
	<script src="../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		$("#formFile").submit(function(e) {
			e.preventDefault();
			$('#divLoading').show();

			var loadingModal = new bootstrap.Modal($("#loadingModal"), {keyboard: false});
			loadingModal.show();
						
			var form = $(this);
			var url = form.attr('action');
			var formData = new FormData($("#formFile").get(0));

			var request = new XMLHttpRequest();
			request.open('POST', url, true);
			request.responseType = 'blob';

			request.onload = function(e) {
				if (this.status === 200) {
					var blob = this.response;
					if(window.navigator.msSaveOrOpenBlob) {
						window.navigator.msSaveBlob(blob, fileName);
					}
					else{
						var downloadLink = window.document.createElement('a');
						var contentTypeHeader = request.getResponseHeader("Content-Type");
						downloadLink.href = window.URL.createObjectURL(new Blob([blob], { type: contentTypeHeader }));
						downloadLink.download = "Resultado.xlsx";
						document.body.appendChild(downloadLink);
						downloadLink.click();
						document.body.removeChild(downloadLink);
					}

					loadingModal.hide();
				}
			};
			request.send(formData);
		});		
	</script>
</body>
</html>